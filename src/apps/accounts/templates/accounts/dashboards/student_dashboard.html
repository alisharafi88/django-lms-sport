{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% trans 'Dashboard' %}</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/meanmenu.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/animate.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/slick.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/backtotop.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/magnific-popup.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/nice-select.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/ui-icon.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/elegentfonts.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/font-awesome-pro.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/spacing.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/rtl.css' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/student-dashboard.css' %}"/>
</head>
<body>
<!-- Sandwich Icon -->
<div class="sandwich-icon" id="sandwich-icon" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</div>

<!-- Blur Overlay -->
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <!-- Profile Section -->
    <div class="profile">
        <img src="{{ user.get_photo_url }}" alt="" id="sidebarProfileImage"/>
        <div class="name" id="sidebarProfileName">{{ user.get_name }}</div>
    </div>

    <!-- Navigation Buttons -->
    <a href="{% url 'home:home' %}" style="color: #ff6f64 ;" class="nav-link" role="button">
        <i class="fas fa-home"></i>
        {% trans 'Home Page' %}
    </a>
    <button onclick="navigateToTab('tab1')">
        <i class="fas fa-futbol"></i> {% trans 'My Courses' %}
    </button>
    <button onclick="navigateToTab('tab2')">
        <i class="fas fa-shopping-cart"></i> {% trans 'Cart' %}
    </button>
    <button onclick="navigateToTab('tab3')">
        <i class="fas fa-envelope"></i> {% trans 'Tickets' %}
    </button>
    <button onclick="navigateToTab('tab4')">
        <i class="fas fa-cog"></i> {% trans 'Settings' %}
    </button>

    <form method="post" action="{% url 'accounts:logout' %}" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout">
            <i class="fas fa-sign-out-alt"></i> {% trans 'LogOut' %}
        </button>
    </form>
</div>


<div class="content" id="content">

    <!-- --------------------------------------بخش دوره های من------------------------------------- -->
    <div class="element" id="element1">
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'My Courses' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <section class="cart-area pt-100 pb-100">
            <div class="container">
                <div class="course-items">
                    {% for course in courses %}
                        <div class="element" data-course-id="{{ course.id }}" data-course-title="{{ course.title }}">
                            <img class="image-square" src="{{ course.img.url }}" alt="{{ course.title }}">
                            <a class="title" href="{{ course.get_absolute_url }}">
                                <h2 class="title">{{ course.title }}</h2>
                            </a>
                            <button class="sort-button" onclick="openModal(this)">{% trans 'Send Comment' %}</button>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Modal -->
            <div id="popup-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
                <div class="modal-content" role="document">
                    <span class="close-button" aria-label="Close" onclick="closeModal()">&times;</span>
                    <h2 id="modal-title">Feedback for Title</h2>
                    <form id="comment-form" method="POST">
                        {% csrf_token %}
                        <div id="rate-error" class="error-message"></div>
                        <div class="star-rating" role="radiogroup" aria-label="Rating">
                            <input type="radio" id="star5" name="rate" value="5" aria-label="5 stars">
                            <label for="star5" title="5 stars">&#9733;</label>
                            <input type="radio" id="star4" name="rate" value="4" aria-label="4 stars">
                            <label for="star4" title="4 stars">&#9733;</label>
                            <input type="radio" id="star3" name="rate" value="3" aria-label="3 stars">
                            <label for="star3" title="3 stars">&#9733;</label>
                            <input type="radio" id="star2" name="rate" value="2" aria-label="2 stars">
                            <label for="star2" title="2 stars">&#9733;</label>
                            <input type="radio" id="star1" name="rate" value="1" aria-label="1 star">
                            <label for="star1" title="1 star">&#9733;</label>
                        </div>
                        <div id="text-error" class="error-message"></div>
                        <textarea
                                id="feedback-text"
                                name="text"
                                placeholder="{% trans 'Write your feedback here...' %}"
                                aria-label="Feedback text"
                        ></textarea>
                        <button type="submit" class="modal-button"
                                aria-label="Submit feedback">{% trans 'Submit' %}</button>
                    </form>
                </div>
            </div>
        </section>
        <!-- ------------------------------------------------------پایان----------------------------------- -->
    </div>

    <!-- ------------------------------------------------------بخش مورد علاقه----------------------------------- -->
    <div class="element" id="element2">
        <!-- Breadcrumb Section -->
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Cart' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <!-- End of Breadcrumb Section -->
        <!-- cart area -->
        <section class="cart-area pt-100 pb-100">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        {% if carts|length %}
                            <div class="table-content table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th class="product-thumbnail">{% trans 'Images' %}</th>
                                        <th class="cart-product-name">{% trans 'Courses' %}</th>
                                        <th class="product-price">{% trans 'Unit Price' %}</th>
                                        <th class="product-subtotal">{% trans 'Total' %}</th>
                                        <th class="product-remove">{% trans 'Remove' %}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for item in carts %}
                                        <tr>
                                            <td class="product-thumbnail"><a
                                                    href="{% url 'courses:course_detail' item.course_obj.id item.course_obj.slug %}"><img
                                                    src="{% static 'assets/img/course/course-thumb-01.jpg' %}"
                                                    alt=""></a>
                                            </td>
                                            <td class="product-name"><a
                                                    href="{% url 'courses:course_detail' item.course_obj.id item.course_obj.slug %}">{{ item.course_obj.title }}</a>
                                            </td>
                                            <td class="product-price"><span
                                                    class="amount">{% trans 'Toman' %}{{ item.course_obj.price }}</span>
                                            </td>
                                            <td class="product-subtotal"><span
                                                    class="amount">{% trans 'Toman' %}{{ item.item_total_price }}</span>
                                            </td>
                                            <td class="product-remove"><a
                                                    href="{% url 'carts:cart_remove' item.course_obj.id %}"><i
                                                    class="fa fa-times"></i></a></td>
                                        </tr>
                                    {% endfor %}

                                    </tbody>
                                </table>

                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="coupon-all">
                                        <div class="coupon">
                                            <input id="coupon_code" class="input-text" name="coupon_code" value=""
                                                   placeholder="Coupon code" type="text">
                                            <button class="tp-btn" name="apply_coupon" type="submit">Apply
                                                coupon
                                            </button>
                                        </div>
                                        <div class="coupon2">
                                            <a href="{% url 'carts:cart_clear' %}">
                                                <button class="tp-btn" type="submit">{% trans 'Clear cart' %}
                                                </button>
                                            </a>
                                            <button class="tp-btn" name="update_cart"
                                                    type="submit">{% trans 'Update cart' %}</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-end">
                                <div class="col-md-5 ">
                                    <div class="cart-page-total">
                                        <h2>Cart totals</h2>
                                        <ul class="mb-20">
                                            <li>{% trans 'Total price' %}
                                                <span>{% trans 'Toman' %}{{ total_price }}</span></li>
                                            <li>{% trans 'Total price after discount' %}
                                                <span>{% trans 'Toman' %}{{ total_discounted_price }}</span></li>
                                        </ul>
                                        <a class="tp-btn"
                                           href="{% url 'orders:order_create' %}">{% trans 'Proceed to checkout' %}% </a>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="col_12">
                                <div class="coupon1">
                                    <p>{% trans 'Your cart is empty!' %}</p>
                                    <a href="{% url 'courses:course_list' %}">
                                        <button class="tp-btn" type="submit">{% trans 'Add course' %}
                                        </button>
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        <!-- cart area end-->
    </div>
    <!-- ----------------------------------------------پایان--------------------------- -->
    <!-- ----------------------------------------------بخش کامنت گزاری--------------------------- -->
    <div class="element" id="element3">
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Tickets' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>


        <section class="cart-area pt-100 pb-100">
            <div class="commentFormContainer">
                <form id="userForm">
                    {% csrf_token %}
                    <input type="text" name="firstName" placeholder="{% trans 'First Name' %}"
                           value="{{ user.first_name }}"/>
                    <input type="text" name="lastName" placeholder="{% trans 'Last Name' %}"
                           value="{{ user.last_name }}"/>
                    <input type="text" name="subject" placeholder="{% trans 'Subject' %}"/>
                    <textarea name="message" placeholder="{% trans 'Your Message' %}"></textarea>
                    <button type="submit">{% trans 'Submit' %}</button>
                </form>
                <div id="responses">
                    {% for ticket in tickets %}
                        <div class="ticket">
                            <div class="comment-details">
                                <h4>{{ ticket.subject }} <span class="place-name">{{ ticket.date_updated }}</span></h4>
                                <h5>{{ ticket.get_status_display }}</h5>
                                <p>{{ ticket.message }}</p>
                            </div>
                            <div class="replies">
                                {% for reply in ticket.replies.all %}
                                    <div class="reply">
                                        <div class="reply-details">
                                            <p>{{ reply.message }}</p>
                                            <small>{{ reply.date_created }}</small>
                                        </div>
                                    </div>
                                {% empty %}
                                    <p class="no-replies">{% trans 'No replies yet.' %}</p>
                                {% endfor %}
                            </div>
                        </div>
                    {% empty %}
                        <p>{% trans 'No tickets found.' %}</p>
                    {% endfor %}
                </div>
            </div>
        </section>
    </div>

    <!-- ------------------------------------------------------پایان----------------------------------- -->

    <!-- ----------------------------------------------بخش ادیت--------------------------- -->
    <div class="element" id="element4">
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Settings' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <section class="cart-area pt-100 pb-100">

            <div class="profile-edit-container">
                <form
                        class="profile-form"
                        action="{% url 'accounts:student_edit_profile' %}"
                        method="post"
                        enctype="multipart/form-data"
                        id="editProfileForm"
                >
                    {% csrf_token %}
                    {{ edit_profile_form.non_field_errors }}
                    <div class="profile-image-section">
                        <img src="{{ request.user.get_photo_url }}"
                             alt="Profile"
                             id="profileImageDisplay"
                             data-default-avatar="{% static 'assets/img/avatar/default-avatar-icon.jpg' %}"/>
                        <input
                                type="file"
                                id="profileImageInput"
                                name="profile_photo"
                                accept="image/*"
                        />
                        <div>
                            <label for="profileImageInput">{% trans 'Change Profile Picture' %}</label>
                            <br>
                            <button type="button"
                                    id="removeProfilePhotoButton"
                                    class="remove-button"
                                    style="display: none;">
                                {% trans 'Remove Profile Picture' %}
                            </button>
                            <input type="hidden" id="remove_profile_photo" name="remove_profile_photo" value="false">

                        </div>
                        {{ edit_profile_form.profile_photo.errors }}
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="id_first_name">{% trans 'First Name' %}</label>
                            <input
                                    type="text"
                                    id="id_first_name"
                                    name="first_name"
                                    value="{{ edit_profile_form.first_name.value|default_if_none:request.user.first_name }}"
                                    placeholder="{% trans 'Enter your first name' %}"
                            />
                            {{ edit_profile_form.first_name.errors }}
                        </div>
                        <div class="input-group">
                            <label for="id_last_name">{% trans 'Last Name' %}</label>
                            <input
                                    type="text"
                                    id="id_last_name"
                                    name="last_name"
                                    value="{{ edit_profile_form.last_name.value|default_if_none:request.user.last_name }}"
                                    placeholder="{% trans 'Enter your last name' %}"
                            />
                            {{ edit_profile_form.last_name.errors }}
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="phoneNumber">{% trans 'Phone Number' %}</label>
                            <input
                                    type="tel"
                                    id="phoneNumber"
                                    name="phone_number"
                                    value="{{ edit_profile_form.phone_number.value|default_if_none:request.user.phone_number }}"
                                    placeholder="{% trans 'Enter your phone number' %}"
                                    readonly

                            />
                            {{ edit_profile_form.phone_number.errors }}
                        </div>
                        <div class="input-group">
                            <label for="emailaddress">{% trans 'Email' %}</label>
                            <input
                                    type="email"
                                    id="emailaddress"
                                    name="email"
                                    value="{{ edit_profile_form.email.value|default_if_none:request.user.email }}"
                                    placeholder="{% trans 'Enter your email' %}"
                            />
                            {{ edit_profile_form.email.errors }}
                        </div>
                    </div>
                    <div class="input-group full-width">
                        <label for="bio">{% trans 'Bio' %}</label>
                        <textarea
                                id="bio"
                                name="bio"
                                placeholder="{% trans 'Tell us about yourself' %}"
                        >{{ edit_profile_form.bio.value|default_if_none:"" }}</textarea>
                        {{ edit_profile_form.bio.errors }}
                    </div>
                    <button type="submit">{% trans 'Save Changes' %}</button>
                </form>
            </div>
        </section>
    </div>

    <!-- ------------------------------------------------------پایان----------------------------------- -->
</div>

<script>
    function navigateToTab(tab) {
        const elements = document.querySelectorAll(".element");
        elements.forEach((element) => element.classList.remove("active"));
        const sidebar = document.getElementById("sidebar");
        const content = document.getElementById("content");
        const overlay = document.getElementById("overlay");
        sidebar.classList.remove("open");
        content.classList.remove("blur");
        overlay.classList.remove("active");

        if (tab === "main") {
            document.getElementById("element-main").classList.add("active");
        } else {
            document
                .getElementById(`element${tab.replace("tab", "")}`)
                .classList.add("active");
        }

        document
            .querySelectorAll(".sidebar button")
            .forEach((button) => button.classList.remove("active"));
        if (tab === "main") {
            document
                .querySelector(".sidebar button:first-child")
                .classList.add("active");
        } else {
            document
                .querySelector(
                    `.sidebar button:nth-child(${tab.replace("tab", "") + 1})`
                )
                .classList.add("active");
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const content = document.getElementById("content");
        const overlay = document.getElementById("overlay");
        sidebar.classList.toggle("open");
        content.classList.toggle("blur");
        overlay.classList.toggle("active");
    }

    window.addEventListener("resize", () => {
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.remove("open");
            document.getElementById("content").classList.remove("blur");
            document.getElementById("overlay").classList.remove("active");
        } else {
            document.getElementById("sidebar").classList.remove("closed");
            document.getElementById("content").classList.remove("blur");
            document.getElementById("overlay").classList.remove("active");
        }
    });


    window.onload = () => {
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.remove("open");
            document.getElementById("content").classList.remove("blur");
            document.getElementById("overlay").classList.remove("active");
        }
        navigateToTab('tab1');
    };

    //--------------------------------------بخش دوره های من--------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("popup-modal");
        const modalTitle = document.getElementById("modal-title");
        const commentForm = document.getElementById("comment-form");
        const rateError = document.getElementById("rate-error");
        const textError = document.getElementById("text-error");

        window.openModal = function (button) {
            const element = button.closest(".element");
            const courseId = element.dataset.courseId;
            const courseTitle = element.dataset.courseTitle;

            modalTitle.textContent = `Feedback for ${courseTitle}`;

            commentForm.action = `/courses/${courseId}/`;

            rateError.textContent = "";
            textError.textContent = "";

            modal.style.display = "block";
            document.body.classList.add("modal-open");
        };

        window.closeModal = function () {
            modal.style.display = "none";
            document.body.classList.remove("modal-open");
        };

        commentForm.addEventListener("submit", (event) => {
            let hasErrors;
            event.preventDefault();

            rateError.textContent = "";
            textError.textContent = "";

            const rating = document.querySelector('input[name="rate"]:checked');
            const feedbackText = document.getElementById("feedback-text").value.trim();

            if (!feedbackText) {
                textError.textContent = "{% trans 'Please enter your feedback.' %}";
                hasErrors = true;
            }
            if (!rating) {
                rateError.textContent = "{% trans 'Please select a rating.' %}";
                hasErrors = true;
            }
            if (hasErrors) {
                return;
            }

            const formData = new FormData(commentForm);
            fetch(commentForm.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
                },
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 400) {
                        return response.json().then((data) => {
                            if (data.errors?.rate) {
                                rateError.textContent = data.errors.rate[0];
                            }
                            if (data.errors?.text) {
                                textError.textContent = data.errors.text[0];
                            }
                            throw new Error(data.errors?.rate || data.errors?.text || "{% trans 'Invalid input.' %}");
                        });
                    } else if (response.status === 403) {
                        return response.json().then((data) => {
                            throw new Error(data.message || "{% trans 'You are not authorized to perform this action.' %}");
                        });
                    } else {
                        throw new Error("{% trans 'An unexpected error occurred.' %}");
                    }
                })
                .then((data) => {
                    showToast(data.message);
                    resetModalForm();
                    closeModal();
                })
                .catch((error) => {
                    showToast(error.message);
                });
        });

        function resetModalForm() {
            commentForm.reset();
            rateError.textContent = "";
            textError.textContent = "";
        }

        function showToast(message) {
            const toast = document.createElement("div");
            toast.className = "toast-message";
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    });
    //------------------------------------------------پایان--------------------------------------

    //------------------------------------------------بخش مورد علاقه ها--------------------------------------

    const likeButtons = document.querySelectorAll(".like-btn");

    likeButtons.forEach((button) => {
        button.addEventListener("click", function () {
            const icon = this.querySelector("i");
            icon.classList.toggle("far");
            icon.classList.toggle("fas");
            this.classList.toggle("liked");
        });
    });

    const starRatings = document.querySelectorAll(".star-rating");

    starRatings.forEach((rating) => {
        const stars = rating.querySelectorAll("i");

        stars.forEach((star) => {
            star.addEventListener("click", function () {
                const ratingValue = parseInt(this.getAttribute("data-rating"));
                stars.forEach((s, index) => {
                    if (index < ratingValue) {
                        s.classList.remove("far");
                        s.classList.add("fas");
                    } else {
                        s.classList.remove("fas");
                        s.classList.add("far");
                    }
                });
            });
        });
    });

    //------------------------------------------------پایان--------------------------------------

    document.addEventListener("DOMContentLoaded", function () {
        //-------------------------------------------------بخش ادیت-------------------------
        const editProfileForm = document.getElementById("editProfileForm");
        const profileImageInput = document.getElementById("profileImageInput");
        const profileImageDisplay = document.getElementById("profileImageDisplay");
        const removeProfilePhotoButton = document.getElementById("removeProfilePhotoButton");
        const removeProfilePhotoInput = document.getElementById("remove_profile_photo");
        const sidebarProfileImage = document.getElementById("sidebarProfileImage");
        const sidebarProfileName = document.getElementById("sidebarProfileName");
        const defaultAvatarUrl = profileImageDisplay.dataset.defaultAvatar;

        function normalizeUrl(url) {
            return new URL(url, window.location.origin).href;
        }

        let hasUploadedPhoto = normalizeUrl(profileImageDisplay.src) !== normalizeUrl(defaultAvatarUrl);

        function toggleRemoveButtonVisibility() {
            if (hasUploadedPhoto) {
                removeProfilePhotoButton.style.display = "inline-block";
                removeProfilePhotoButton.textContent = "{% trans 'Remove Profile Picture' %}";
                removeProfilePhotoButton.style.backgroundColor = "#dc3545";
            } else {
                removeProfilePhotoButton.style.display = "none";
            }
        }

        profileImageInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    profileImageDisplay.setAttribute("src", event.target.result);
                    hasUploadedPhoto = true;
                    toggleRemoveButtonVisibility();
                };
                reader.readAsDataURL(file);
                removeProfilePhotoInput.value = "false";
            }
        });

        removeProfilePhotoButton.addEventListener("click", function () {
            if (removeProfilePhotoInput.value === "false") {
                removeProfilePhotoInput.value = "true";
                profileImageDisplay.setAttribute("src", defaultAvatarUrl);
                profileImageInput.value = "";
                hasUploadedPhoto = false;
                removeProfilePhotoButton.textContent = "{% trans 'Undo Remove Profile Picture' %}";
                removeProfilePhotoButton.style.backgroundColor = "#28a745";
                removeProfilePhotoButton.style.display = "inline-block";
            } else {
                removeProfilePhotoInput.value = "false";
                profileImageDisplay.setAttribute("src", "{{ request.user.get_photo_url }}");
                hasUploadedPhoto = true;
                removeProfilePhotoButton.textContent = "{% trans 'Remove Profile Picture' %}";
                removeProfilePhotoButton.style.backgroundColor = "#dc3545";
                toggleRemoveButtonVisibility();
            }
        });

        editProfileForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("{% url 'accounts:student_edit_profile' %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        alert(data.message);
                        if (data.profile_photo_url) {
                            profileImageDisplay.setAttribute("src", data.profile_photo_url);
                            sidebarProfileImage.setAttribute("src", data.profile_photo_url);
                        } else {
                            profileImageDisplay.setAttribute("src", defaultAvatarUrl);
                            sidebarProfileImage.setAttribute("src", defaultAvatarUrl);
                        }
                        if (data.full_name) {
                            sidebarProfileName.textContent = data.full_name;
                        }
                        hasUploadedPhoto = data.has_uploaded_photo;
                        removeProfilePhotoInput.value = "false";
                        removeProfilePhotoButton.textContent = "{% trans 'Remove Profile Picture' %}";
                        removeProfilePhotoButton.style.backgroundColor = "#dc3545";
                        toggleRemoveButtonVisibility();
                    } else {
                        alert(data.message);
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An unexpected error occurred. Please try again.");
                });
        });

        toggleRemoveButtonVisibility();
        //------------------------------------------------پایان--------------------------------------

        const userForm = document.getElementById("userForm");
        if (userForm) {
            userForm.addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(userForm);
                const csrftoken = getCookie("csrftoken");

                fetch("{% url 'accounts:student_create_ticket' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": csrftoken,
                    },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            userForm.reset();

                            const noTicketsMessage = document.querySelector("#responses > p");
                            if (noTicketsMessage && noTicketsMessage.textContent.trim() === "{% trans 'No tickets found.' %}") {
                                noTicketsMessage.remove();
                            }

                            const ticket = data.ticket;
                            const newTicketElement = document.createElement("div");
                            newTicketElement.className = "ticket";

                            // Comment Details
                            const commentDetails = document.createElement("div");
                            commentDetails.className = "comment-details";

                            const h4 = document.createElement("h4");
                            h4.innerHTML = `${ticket.subject} <span class="place-name">${ticket.date_updated}</span>`;

                            const h5 = document.createElement("h5");
                            h5.textContent = ticket.status;

                            const p = document.createElement("p");
                            p.textContent = ticket.message;

                            commentDetails.appendChild(h4);
                            commentDetails.appendChild(h5);
                            commentDetails.appendChild(p);

                            const repliesDiv = document.createElement("div");
                            repliesDiv.className = "replies";

                            const noReplies = document.createElement("p");
                            noReplies.className = "no-replies";
                            noReplies.textContent = "{% trans 'No replies yet.' %}";

                            repliesDiv.appendChild(noReplies);

                            newTicketElement.appendChild(commentDetails);
                            newTicketElement.appendChild(repliesDiv);

                            document.getElementById("responses").prepend(newTicketElement);

                            alert(data.message);
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert("{% trans 'An error occurred while submitting the form.' %}");
                    });
            });
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
</body>
</html>
