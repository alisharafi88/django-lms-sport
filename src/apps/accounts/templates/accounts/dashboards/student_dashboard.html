{% load persian_tags %}
{% load i18n %}
{% load static %}
{% load jalali_tags %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% trans 'Dashboard' %}</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'assets/css/student-dashboard.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}"/>
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/meanmenu.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/animate.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/slick.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/backtotop.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/magnific-popup.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/nice-select.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/ui-icon.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/elegentfonts.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/font-awesome-pro.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/spacing.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/rtl.css' %}">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'assets/img/favicon.png' %}">
    <link rel="stylesheet" href="{% static 'assets/css/message.css' %}">
    <style>
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
            z-index: 1001;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .cart-page-total {
            transition: all 0.3s ease-in-out;
            opacity: 1;
            transform: translateX(0);
        }

        .cart-page-total.updating {
            opacity: 0.5;
            transform: translateX(-10px);
        }

        .price-item {
            position: relative;
            padding: 8px 0;
        }

        .price-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: #e0e0e0;
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .price-item.updated::after {
            transform: scaleX(1);
        }

        .checkout-button {
            transition: all 0.3s ease;
            opacity: 1;
            transform: translateY(0);
        }

        .checkout-button.hide {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .order-header {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .order-header:hover {
            background-color: #f8f9fa;
        }

        .collapse:not(.show) {
            display: none;
        }

        .collapse.show {
            display: table-row;
        }

        .dvd-details {
            transition: all 0.3s ease-in-out;
        }

        .order-header[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
            transition: transform 0.3s ease;
        }

        .card.bg-light {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

<!-- messages area start -->
{% include 'inc/message.html' %}
<!-- messages area start -->

<!-- Sandwich Icon -->
<div class="sandwich-icon" id="sandwich-icon" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</div>

<!-- Blur Overlay -->
<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <!-- Profile Section -->
    <div class="profile">
        <img src="{{ user.get_photo_url }}" alt="" id="sidebarProfileImage"/>
        <div class="name" id="sidebarProfileName">{{ user.get_name }}</div>
    </div>

    <!-- Navigation Buttons -->
    <a href="{% url 'home:home' %}" style="color: #ff6f64 ;" class="nav-link" role="button">
        <i class="fas fa-home"></i>
        {% trans 'HomePage' %}
    </a>
    <button onclick="navigateToTab('tab1')">
        <i class="fas fa-futbol"></i> {% trans 'My Courses' %}
    </button>
    <button onclick="navigateToTab('tab2')">
        <i class="fas fa-shopping-cart"></i> {% trans 'Cart' %}
    </button>
    <button onclick="navigateToTab('tab3')">
        <i class="fa-solid fa-credit-card-front"></i> {% trans 'Orders' %}
    </button>
    <button onclick="navigateToTab('tab4')">
        <i class="fas fa-envelope"></i> {% trans 'Tickets' %}
    </button>
    <button onclick="navigateToTab('tab5')">
        <i class="fas fa-cog"></i> {% trans 'Settings' %}
    </button>

    <form method="post" action="{% url 'accounts:logout' %}" class="logout-form">
        {% csrf_token %}
        <button type="submit" class="logout">
            <i class="fas fa-sign-out-alt"></i> {% trans 'LogOut' %}
        </button>
    </form>
</div>


<div class="content" id="content">

    <!-- --------------------------------------بخش دوره های من------------------------------------- -->
    <div class="element" id="element1">
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'My Courses' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <section class="pt-100 pb-100">
            <div class="container_content">
                <div class="course-items">
                    {% if courses %}
                        {% for course in courses %}
                            <div class="element" data-course-id="{{ course.id }}"
                                 data-course-title="{{ course.title }}">
                                <img class="image-square" src="{{ course.img.url }}" alt="{{ course.title }}">
                                <a class="title" href="{{ course.get_absolute_url }}">
                                    <h2 class="title">{{ course.title }}</h2>
                                </a>
                                {% if course.link %}
                                    <button class="copy ml-5" data-link="{{ course.link }}">
                                        <span data-text-end="{% trans 'Copied!' %}" data-text-initial="{% trans 'Copy link' %}" class="tooltip"></span>
                                        <span>
                                            <svg xml:space="preserve" style="enable-background:new 0 0 512 512" viewBox="0 0 6.35 6.35" y="0" x="0" height="20" width="20" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg" class="clipboard">
                                                <g>
                                                    <path fill="currentColor" d="M2.43.265c-.3 0-.548.236-.573.53h-.328a.74.74 0 0 0-.735.734v3.822a.74.74 0 0 0 .735.734H4.82a.74.74 0 0 0 .735-.734V1.529a.74.74 0 0 0-.735-.735h-.328a.58.58 0 0 0-.573-.53zm0 .529h1.49c.032 0 .049.017.049.049v.431c0 .032-.017.049-.049.049H2.43c-.032 0-.05-.017-.05-.049V.843c0-.032.018-.05.05-.05zm-.901.53h.328c.026.292.274.528.573.528h1.49a.58.58 0 0 0 .573-.529h.328a.2.2 0 0 1 .206.206v3.822a.2.2 0 0 1-.206.205H1.53a.2.2 0 0 1-.206-.205V1.529a.2.2 0 0 1 .206-.206z"></path>
                                                </g>
                                            </svg>
                                            <svg xml:space="preserve" style="enable-background:new 0 0 512 512" viewBox="0 0 24 24" y="0" x="0" height="18" width="18" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg" class="checkmark">
                                                <g>
                                                    <path data-original="#000000" fill="currentColor" d="M9.707 19.121a.997.997 0 0 1-1.414 0l-5.646-5.647a1.5 1.5 0 0 1 0-2.121l.707-.707a1.5 1.5 0 0 1 2.121 0L9 14.171l9.525-9.525a1.5 1.5 0 0 1 2.121 0l.707.707a1.5 1.5 0 0 1 0 2.121z"></path>
                                                </g>
                                            </svg>
                                        </span>
                                    </button>
                                {% endif %}
                                <button class="sort-button"
                                        onclick="openModal(this)">{% trans 'Send Comment' %}
                                </button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-courses-message">
                            <p>{% trans "You haven't purchased any courses yet." %}</p>
                            <a href="{% url 'courses:course_list' %}" class="tp-btn">
                                {% trans 'Browse Courses' %}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Modal -->
            <div id="popup-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
                <div class="modal-content" role="document">
                    <span class="close-button" aria-label="Close" onclick="closeModal()">&times;</span>
                    <h2 id="modal-title">{% trans 'Feedback for Title' %} "<span id="course-title"></span>"</h2>
                    <form id="comment-form" method="POST">
                        {% csrf_token %}
                        <div id="rate-error" class="error-message"></div>
                        <div class="star-rating" role="radiogroup" aria-label="Rating">
                            <input type="radio" id="star5" name="rate" value="5" aria-label="5 stars">
                            <label for="star5" title="5 stars">&#9733;</label>
                            <input type="radio" id="star4" name="rate" value="4" aria-label="4 stars">
                            <label for="star4" title="4 stars">&#9733;</label>
                            <input type="radio" id="star3" name="rate" value="3" aria-label="3 stars">
                            <label for="star3" title="3 stars">&#9733;</label>
                            <input type="radio" id="star2" name="rate" value="2" aria-label="2 stars">
                            <label for="star2" title="2 stars">&#9733;</label>
                            <input type="radio" id="star1" name="rate" value="1" aria-label="1 star">
                            <label for="star1" title="1 star">&#9733;</label>
                        </div>
                        <div id="text-error" class="error-message"></div>
                        <textarea
                                id="feedback-text"
                                name="text"
                                placeholder="{% trans 'Write your feedback here...' %}"
                                aria-label="Feedback text"
                        ></textarea>
                        <button type="submit" class="modal-button"
                                aria-label="Submit feedback">{% trans 'Submit' %}</button>
                    </form>
                </div>
            </div>
        </section>
        <!-- ------------------------------------------------------پایان----------------------------------- -->
    </div>

    <!-- ------------------------------------------------------بخش مورد علاقه----------------------------------- -->
    <div class="element" id="element2">
        <!-- Breadcrumb Section -->
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Cart' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <!-- End of Breadcrumb Section -->
        <!-- cart area -->
        <section class="cart-area pt-100 pb-100">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        {% if carts|length %}
                            <div class="table-content table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th class="product-thumbnail">{% trans 'Images' %}</th>
                                        <th class="cart-product-name">{% trans 'Products' %}</th>
                                        <th class="product-price">{% trans 'Unit Price' %}</th>
                                        <th class="product-subtotal">{% trans 'Total' %}</th>
                                        <th class="product-remove">{% trans 'Remove' %}</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for item in carts %}
                                        <tr data-product-id="{{ item.product_obj.id }}"
                                            data-product-type="{{ item.type }}"
                                            data-remove-url="{% url 'carts:cart_remove' 0 'type' %}">
                                            <td class="product-thumbnail">
                                                <a href="{% if item.product_obj.type == 'course' %}{% url 'courses:course_detail'  item.product_obj.slug %}{% else %}{% url 'courses:package_detail' item.product_obj.slug %}{% endif %}">
                                                    <img src="{{ item.product_obj.img.url }}"
                                                         alt="{{ item.product_obj.title }}">
                                                </a>
                                            </td>
                                            <td class="product-name">
                                                <a href="{% if item.product_obj.type == 'course' %}{% url 'courses:course_detail'  item.product_obj.slug %}{% else %}{% url 'courses:package_detail' item.product_obj.slug %}{% endif %}">
                                                    {{ item.product_obj.title }}
                                                </a>
                                            </td>
                                            <td class="product-price">
                                                <span class="amount price">{{ item.product_obj.price|to_persian_number:'humanize' }} {% trans 'Toman' %}</span>
                                            </td>
                                            <td class="product-subtotal">
                                                <span class="amount">{{ item.item_total_price|to_persian_number:'humanize' }} {% trans 'Toman' %}</span>
                                            </td>
                                            <td class="product-remove">
                                                <a href="#" class="remove-from-cart-ajax">
                                                    <i class="fa fa-times"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="coupon-all">
                                        <div class="coupon2">
                                            <button class="tp-btn clear-cart-ajax"
                                                    type="submit"
                                                    data-clear-url="{% url 'carts:cart_clear' %}"
                                            >{% trans 'Clear cart' %}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row justify-content-end">
                                <div class="col-md-5 ">
                                    <div class="cart-page-total">
                                        <h2>Cart totals</h2>
                                        <ul class="mb-20">
                                            <li class="total-price-item">{% trans 'Total price' %}
                                                <span>{{ total_price|to_persian_number:'humanize'  }} {% trans 'Toman' %}</span>
                                            </li>
                                            <li class="discounted-price-item">{% trans 'Total price after discount' %}
                                                <span>{{ total_discounted_price|to_persian_number:'humanize' }} {% trans 'Toman' %}</span></li>
                                        </ul>
                                        <a class="tp-btn"
                                           href="{% url 'orders:order_create' %}">{% trans 'Proceed to checkout' %}</a>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="col-12">
                                <div class="coupon1">
                                    <p>{% trans 'Your cart is empty!' %}</p>
                                    <a href="{% url 'courses:course_list' %}">
                                        <button class="tp-btn" type="submit">{% trans 'Add course' %}
                                        </button>
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <input
                    type="hidden"
                    id="csrf-token"
                    value="{{ csrf_token }}"
                    data-csrf="{{ csrf_token }}"
                    readonly
                    aria-hidden="true"
            >
        </section>
        <!-- cart area end-->
    </div>
    <!-- ----------------------------------------------پایان--------------------------- -->

    <!-- ------------------------------------------------------بخش سفارش‌ها----------------------------------- -->
    <div class="element" id="element3">
        <!-- Breadcrumb Section -->
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Orders' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <!-- End of Breadcrumb Section -->
        <!-- order area -->
        <section class="order-area pt-100 pb-100">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        {% if orders.exists %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <tbody>
                                    {% for order in orders %}
                                        <!-- Order Header -->
                                        <tr class="order-header" data-bs-toggle="collapse"
                                            data-bs-target="#dvd-{{ order.id }}" aria-expanded="false">
                                            <td colspan="5">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>{% trans 'Order' %} {{ order.id|to_persian_number }}#</strong>
                                                        <small class="text-muted">{{ order.date_created|to_jalali|to_persian_number }}</small>
                                                    </div>
                                                    {% if order.access_status == 'd' %}
                                                        <div>
                                                            <i class="fas fa-chevron-down ms-2"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Order Details -->
                                        <tr>
                                            <td colspan="5">
                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <strong>{% trans 'Total' %}:</strong><br>
                                                        {{ order.total_price|to_persian_number:'humanize' }} {% trans 'Toman' %}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>{% trans 'Status' %}:</strong><br>
                                                        <span class="badge
                                                            {% if order.status == 'p' %}bg-success
                                                            {% elif order.status == 'u' %}bg-warning
                                                            {% else %}bg-danger{% endif %}">
                                                            {{ order.get_status_display }}
                                                        </span>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>{% trans 'Access' %}:</strong><br>
                                                        {{ order.get_access_status_display }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>{% trans 'Items' %}:</strong><br>
                                                        {% for item in order.items.all %}
                                                            <div>{{ item.product.title }}</div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Collapsible DVD Details -->
                                        {% if order.access_status == 'd' %}
                                            <tr class="collapse dvd-details" id="dvd-{{ order.id }}">
                                                <td colspan="5">
                                                    <div class="card card-body bg-light mt-3">
                                                        <h6>{% trans 'Shipping Information' %}</h6>
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <p>
                                                                    <strong>{% trans 'Address' %}:</strong><br>
                                                                    {{ order.dvd_detail.address }}, {{ order.dvd_detail.city }}<br>
                                                                    {% trans 'Postal Code' %}: {{ order.dvd_detail.postal_code|to_persian_number }}
                                                                </p>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <p>
                                                                    <strong>{% trans 'Contact' %}:</strong><br>
                                                                    {% trans 'Phone' %}: {{ order.dvd_detail.phone_number|to_persian_number }}<br>
                                                                    {% trans 'Email' %}: {{ order.dvd_detail.email }}
                                                                </p>
                                                            </div>
                                                            <div class="col-12">
                                                                <strong>{% trans 'Delivery Status' %}:</strong>
                                                                <span class="badge
                                                                    {% if order.dvd_detail.delivery_status == 's' %}bg-success
                                                                    {% elif order.dvd_detail.delivery_status == 'p' %}bg-warning
                                                                    {% else %}bg-danger{% endif %}">
                                                                    {{ order.dvd_detail.get_delivery_status_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center">
                                <p>{% trans 'No orders found' %}</p>
                                <a href="{% url 'courses:course_list' %}" class="btn btn-primary">
                                    {% trans 'Browse Courses' %}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
        <!-- cart area end-->
    </div>
    <!-- ----------------------------------------------پایان--------------------------- -->

    <!-- ----------------------------------------------بخش کامنت گزاری--------------------------- -->
    <div class="element" id="element4">
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Tickets' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>


        <section class="pt-100 pb-100">
            <div class="commentFormContainer">
                <form id="userForm">
                    {% csrf_token %}
                    <input type="text" name="firstName" placeholder="{% trans 'First Name' %}"
                           value="{{ user.first_name }}"/>
                    <input type="text" name="lastName" placeholder="{% trans 'Last Name' %}"
                           value="{{ user.last_name }}"/>
                    <input type="text" name="subject" placeholder="{% trans 'Subject' %}"/>
                    <textarea name="message" placeholder="{% trans 'Your Message' %}"></textarea>
                    <button type="submit">{% trans 'Submit' %}</button>
                </form>
                <div id="responses">
                    {% for ticket in tickets %}
                        <div class="ticket">
                            <div class="comment-details">
                                <h4>{{ ticket.subject }} <span
                                        class="place-name">{{ ticket.date_updated|to_jalali|to_persian_number }}</span></h4>
                                <h5>{{ ticket.get_status_display }}</h5>
                                <p>{{ ticket.message }}</p>
                            </div>
                            <div class="replies">
                                {% for reply in ticket.replies.all %}
                                    <div class="reply">
                                        <div class="reply-details">
                                            <p>{{ reply.message }}</p>
                                            <small>{{ reply.date_created|to_jalali|to_persian_number }}</small>
                                        </div>
                                    </div>
                                {% empty %}
                                    <p class="no-replies">{% trans 'No replies yet.' %}</p>
                                {% endfor %}
                            </div>
                        </div>
                    {% empty %}
                        <p>{% trans 'No tickets found.' %}</p>
                    {% endfor %}
                </div>
            </div>
        </section>
    </div>

    <!-- ------------------------------------------------------پایان----------------------------------- -->

    <!-- ----------------------------------------------بخش ادیت--------------------------- -->
    <div class="element" id="element5">
        <section class="breadcrumb-section py-4" style="background-color: #f9fafb;">
            <div class="container">
                <div class="row align-items-center">
                    <!-- Breadcrumb Path -->
                    <div class="col-lg-8 col-md-12">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 p-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'home:home' %}"
                                       class="text-decoration-none text-dark">{% trans 'Home' %}</a>
                                </li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted" aria-current="page">{% trans 'Dashboard' %}</li>
                                <li class="dvdr"><i class="fa-regular fa-angle-left"></i></li>
                                <li class="active text-muted"
                                    aria-current="page">{% trans 'Settings' %}</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <section class="pt-100 pb-100">

            <div class="profile-edit-container">
                <form
                        class="profile-form"
                        action="{% url 'accounts:student_edit_profile' %}"
                        method="post"
                        enctype="multipart/form-data"
                        id="editProfileForm"
                >
                    {% csrf_token %}
                    {{ edit_profile_form.non_field_errors }}
                    <div class="profile-image-section">
                        <img src="{{ request.user.get_photo_url }}"
                             alt="Profile"
                             id="profileImageDisplay"
                             data-default-avatar="{% static 'assets/img/avatar/default-avatar-icon.jpg' %}"/>
                        <input
                                type="file"
                                id="profileImageInput"
                                name="profile_photo"
                                accept="image/*"
                        />
                        <div>
                            <label for="profileImageInput">{% trans 'Change Profile Picture' %}</label>
                            <br>
                            <button type="button"
                                    id="removeProfilePhotoButton"
                                    class="remove-button"
                                    style="display: none;">
                                {% trans 'Remove Profile Picture' %}
                            </button>
                            <input type="hidden" id="remove_profile_photo" name="remove_profile_photo" value="false">

                        </div>
                        {{ edit_profile_form.profile_photo.errors }}
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="id_first_name">{% trans 'First Name' %}</label>
                            <input
                                    type="text"
                                    id="id_first_name"
                                    name="first_name"
                                    value="{{ edit_profile_form.first_name.value|default_if_none:request.user.first_name }}"
                                    placeholder="{% trans 'Enter your first name' %}"
                            />
                            {{ edit_profile_form.first_name.errors }}
                        </div>
                        <div class="input-group">
                            <label for="id_last_name">{% trans 'Last Name' %}</label>
                            <input
                                    type="text"
                                    id="id_last_name"
                                    name="last_name"
                                    value="{{ edit_profile_form.last_name.value|default_if_none:request.user.last_name }}"
                                    placeholder="{% trans 'Enter your last name' %}"
                            />
                            {{ edit_profile_form.last_name.errors }}
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label for="phoneNumber">{% trans 'Phone Number' %}</label>
                            <input
                                    type="tel"
                                    id="phoneNumber"
                                    name="phone_number"
                                    value="{{ edit_profile_form.phone_number.value|default_if_none:request.user.phone_number|to_persian_number }}"
                                    placeholder="{% trans 'Enter your phone number' %}"
                                    readonly

                            />
                            {{ edit_profile_form.phone_number.errors }}
                        </div>
                        <div class="input-group">
                            <label for="emailaddress">{% trans 'Email' %}</label>
                            <input
                                    type="email"
                                    id="emailaddress"
                                    name="email"
                                    value="{{ edit_profile_form.email.value|default_if_none:request.user.email }}"
                                    placeholder="{% trans 'Enter your email' %}"
                            />
                            {{ edit_profile_form.email.errors }}
                        </div>
                    </div>
                    <div class="input-group full-width">
                        <label for="bio">{% trans 'Bio' %}</label>
                        <textarea
                                id="bio"
                                name="bio"
                                placeholder="{% trans 'Tell us about yourself' %}"
                        >{{ edit_profile_form.bio.value|default_if_none:"" }}</textarea>
                        {{ edit_profile_form.bio.errors }}
                    </div>
                    <button type="submit">{% trans 'Save Changes' %}</button>
                </form>
            </div>
        </section>
    </div>

    <!-- ------------------------------------------------------پایان----------------------------------- -->
</div>

<script>
    function navigateToTab(tab) {
        const elements = document.querySelectorAll(".element");
        elements.forEach((element) => element.classList.remove("active"));
        const sidebar = document.getElementById("sidebar");
        const content = document.getElementById("content");
        const overlay = document.getElementById("overlay");
        sidebar.classList.remove("open");
        content.classList.remove("blur");
        overlay.classList.remove("active");

        if (tab === "main") {
            document.getElementById("element-main").classList.add("active");
        } else {
            document
                .getElementById(`element${tab.replace("tab", "")}`)
                .classList.add("active");
        }

        document
            .querySelectorAll(".sidebar button")
            .forEach((button) => button.classList.remove("active"));
        if (tab === "main") {
            document
                .querySelector(".sidebar button:first-child")
                .classList.add("active");
        } else {
            document
                .querySelector(
                    `.sidebar button:nth-child(${tab.replace("tab", "") + 1})`
                )
                .classList.add("active");
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const content = document.getElementById("content");
        const overlay = document.getElementById("overlay");
        sidebar.classList.toggle("open");
        content.classList.toggle("blur");
        overlay.classList.toggle("active");
    }

    window.addEventListener("resize", () => {
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.remove("open");
            document.getElementById("content").classList.remove("blur");
            document.getElementById("overlay").classList.remove("active");
        } else {
            document.getElementById("sidebar").classList.remove("closed");
            document.getElementById("content").classList.remove("blur");
            document.getElementById("overlay").classList.remove("active");
        }
    });


    window.onload = () => {
        if (window.innerWidth <= 768) {
            document.getElementById("sidebar").classList.remove("open");
            document.getElementById("content").classList.remove("blur");
            document.getElementById("overlay").classList.remove("active");
        }
        navigateToTab('tab1');
    };

    //--------------------------------------بخش دوره های من--------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("popup-modal");
        const modalTitle = document.getElementById("modal-title");
        const commentForm = document.getElementById("comment-form");
        const rateError = document.getElementById("rate-error");
        const textError = document.getElementById("text-error");

        window.openModal = function (button) {
            const element = button.closest(".element");
            const courseId = element.dataset.courseId;
            const courseTitle = element.dataset.courseTitle;

            document.getElementById('course-title').textContent = courseTitle;

            commentForm.action = `/courses/${courseId}/`;

            rateError.textContent = "";
            textError.textContent = "";

            modal.style.display = "block";
            document.body.classList.add("modal-open");
        };

        window.closeModal = function () {
            modal.style.display = "none";
            document.body.classList.remove("modal-open");
        };

        commentForm.addEventListener("submit", (event) => {
            let hasErrors;
            event.preventDefault();

            rateError.textContent = "";
            textError.textContent = "";

            const rating = document.querySelector('input[name="rate"]:checked');
            const feedbackText = document.getElementById("feedback-text").value.trim();

            if (!feedbackText) {
                textError.textContent = "{% trans 'Please enter your feedback.' %}";
                hasErrors = true;
            }
            if (!rating) {
                rateError.textContent = "{% trans 'Please select a rating.' %}";
                hasErrors = true;
            }
            if (hasErrors) {
                return;
            }

            const formData = new FormData(commentForm);
            fetch(commentForm.action, {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
                },
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 400) {
                        return response.json().then((data) => {
                            if (data.errors?.rate) {
                                rateError.textContent = data.errors.rate[0];
                            }
                            if (data.errors?.text) {
                                textError.textContent = data.errors.text[0];
                            }
                            throw new Error(data.errors?.rate || data.errors?.text || "{% trans 'Invalid input.' %}");
                        });
                    } else if (response.status === 403) {
                        return response.json().then((data) => {
                            throw new Error(data.message || "{% trans 'You are not authorized to perform this action.' %}");
                        });
                    } else {
                        throw new Error("{% trans 'An unexpected error occurred.' %}");
                    }
                })
                .then((data) => {
                    showMessage(data.message, 'success');
                    resetModalForm();
                    closeModal();
                })
                .catch((error) => {
                    showMessage(error.message, 'error');
                });
        });

        function resetModalForm() {
            commentForm.reset();
            rateError.textContent = "";
            textError.textContent = "";
        }

        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), type === 'error' ? 5000 : 3000);
        }
    });
    //------------------------------------------------پایان--------------------------------------

    //------------------------------------------------بخش مورد علاقه ها--------------------------------------

    document.addEventListener('DOMContentLoaded', function () {
        const csrftoken = document.querySelector('#csrf-token').value;

        document.querySelectorAll('.remove-from-cart-ajax').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();

                const row = button.closest('tr');
                const productId = row.dataset.productId;
                const productType = row.dataset.productType;
                let url_remove = row.dataset.removeUrl
                    .replace('0', productId)
                    .replace('type', productType);

                try {
                    const response = await fetch(url_remove, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        row.remove();

                        updateCartSummary(data);

                        showMessage(data.message, 'success');

                        if (data.cart_empty) {
                            document.querySelector('.cart-area').innerHTML = `
                        <div class="container">
                            <div class="row">
                                <div class="col-12">
                                    <div class="coupon1">
                                        <p>{% trans 'Your cart is empty!' %}</p>
                                        <a href="{% url 'courses:course_list' %}">
                                            <button class="tp-btn">{% trans 'Add course' %}</button>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        }
                    } else {
                        showMessage(data.message, 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showMessage("{% trans 'An error occurred' %}", 'error');
                }
            });
        });

        document.querySelector('.clear-cart-ajax').addEventListener('click', async (e) => {
            e.preventDefault();

            if (!confirm("{% trans 'Are you sure you want to clear your cart?' %}")) return;

            const button = e.target.closest('button');
            const url_clear = button.dataset.clearUrl;

            button.disabled = true;
            button.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2"></span>
            {% trans 'Clearing...' %}
        `;

            try {
                const response = await fetch(url_clear, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                });

                const data = await response.json();

                if (data.status === 'success') {
                    document.querySelector('tbody').innerHTML = '';

                    updateCartSummary(data);

                    document.querySelector('.cart-area').innerHTML = `

                <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="coupon1">
                            <p>{% trans 'Your cart is empty!' %}</p>
                            <a href="{% url 'courses:course_list' %}">
                                <button class="tp-btn">{% trans 'Add course' %}</button>
                            </a>
                        </div>
                    </div>
                    </div>
                </div>
            `;

                    showMessage(data.message, 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage("{% trans 'An error occurred' %}", 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = "{% trans 'Clear cart' %}";
            }
        });

        function updateCartSummary(data) {
            const cartTotalSection = document.querySelector('.cart-page-total');
            const totalPrice = document.querySelector('.cart-page-total li:first-child span');
            const discountedPrice = document.querySelector('.cart-page-total li:nth-child(2) span');
            const checkoutButton = document.querySelector('.checkout-button');

            cartTotalSection.classList.add('updating');

            if (totalPrice) {
                totalPrice.textContent = `${data.total_price} {% trans 'Toman' %} `;
                totalPrice.style.animation = 'pulse 0.5s ease';
            }
            setTimeout(() => {
                if (discountedPrice) {
                    discountedPrice.textContent = `${data.total_discounted_price.toLocaleString()} {% trans 'Toman' %} `;
                    discountedPrice.closest('li').classList.add('updated');
                }

                // Handle checkout button visibility
                if (checkoutButton) {
                    if (data.cart_empty) {
                        checkoutButton.classList.add('hide');
                        setTimeout(() => checkoutButton.style.display = 'none', 300);
                    } else {
                        checkoutButton.style.display = 'inline-block';
                        setTimeout(() => checkoutButton.classList.remove('hide'), 10);
                    }
                }

                // Remove animation classes after transition
                setTimeout(() => {
                    cartTotalSection.classList.remove('updating');
                    document.querySelectorAll('.price-item').forEach(item => {
                        item.classList.remove('updated');
                    });
                }, 500);
            }, 300);
        }


        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), type === 'error' ? 5000 : 3000);
        }

    });

    //------------------------------------------------پایان--------------------------------------

    document.addEventListener("DOMContentLoaded", function () {
        //-------------------------------------------------بخش ادیت-------------------------
        const editProfileForm = document.getElementById("editProfileForm");
        const profileImageInput = document.getElementById("profileImageInput");
        const profileImageDisplay = document.getElementById("profileImageDisplay");
        const removeProfilePhotoButton = document.getElementById("removeProfilePhotoButton");
        const removeProfilePhotoInput = document.getElementById("remove_profile_photo");
        const sidebarProfileImage = document.getElementById("sidebarProfileImage");
        const sidebarProfileName = document.getElementById("sidebarProfileName");
        const defaultAvatarUrl = profileImageDisplay.dataset.defaultAvatar;

        function normalizeUrl(url) {
            return new URL(url, window.location.origin).href;
        }

        let hasUploadedPhoto = normalizeUrl(profileImageDisplay.src) !== normalizeUrl(defaultAvatarUrl);

        function toggleRemoveButtonVisibility() {
            if (hasUploadedPhoto) {
                removeProfilePhotoButton.style.display = "inline-block";
                removeProfilePhotoButton.textContent = "{% trans 'Remove Profile Picture' %}";
                removeProfilePhotoButton.style.backgroundColor = "#dc3545";
            } else {
                removeProfilePhotoButton.style.display = "none";
            }
        }

        profileImageInput.addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    profileImageDisplay.setAttribute("src", event.target.result);
                    hasUploadedPhoto = true;
                    toggleRemoveButtonVisibility();
                };
                reader.readAsDataURL(file);
                removeProfilePhotoInput.value = "false";
            }
        });

        removeProfilePhotoButton.addEventListener("click", function () {
            if (removeProfilePhotoInput.value === "false") {
                removeProfilePhotoInput.value = "true";
                profileImageDisplay.setAttribute("src", defaultAvatarUrl);
                profileImageInput.value = "";
                hasUploadedPhoto = false;
                removeProfilePhotoButton.textContent = "{% trans 'Undo Remove Profile Picture' %}";
                removeProfilePhotoButton.style.backgroundColor = "#28a745";
                removeProfilePhotoButton.style.display = "inline-block";
            } else {
                removeProfilePhotoInput.value = "false";
                profileImageDisplay.setAttribute("src", "{{ request.user.get_photo_url }}");
                hasUploadedPhoto = true;
                removeProfilePhotoButton.textContent = "{% trans 'Remove Profile Picture' %}";
                removeProfilePhotoButton.style.backgroundColor = "#dc3545";
                toggleRemoveButtonVisibility();
            }
        });

        editProfileForm.addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch("{% url 'accounts:student_edit_profile' %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        showMessage(data.message, 'success')
                        if (data.profile_photo_url) {
                            profileImageDisplay.setAttribute("src", data.profile_photo_url);
                            sidebarProfileImage.setAttribute("src", data.profile_photo_url);
                        } else {
                            profileImageDisplay.setAttribute("src", defaultAvatarUrl);
                            sidebarProfileImage.setAttribute("src", defaultAvatarUrl);
                        }
                        if (data.full_name) {
                            sidebarProfileName.textContent = data.full_name;
                        }
                        hasUploadedPhoto = data.has_uploaded_photo;
                        removeProfilePhotoInput.value = "false";
                        removeProfilePhotoButton.textContent = "{% trans 'Remove Profile Picture' %}";
                        removeProfilePhotoButton.style.backgroundColor = "#dc3545";
                        toggleRemoveButtonVisibility();
                    } else {
                        showMessage(data.message, 'error')
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                    alert("An unexpected error occurred. Please try again.");
                });
        });

        toggleRemoveButtonVisibility();
        //------------------------------------------------پایان--------------------------------------

        const userForm = document.getElementById("userForm");
        if (userForm) {
            userForm.addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(userForm);
                const csrftoken = getCookie("csrftoken");

                fetch("{% url 'accounts:student_create_ticket' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": csrftoken,
                    },
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            userForm.reset();

                            const noTicketsMessage = document.querySelector("#responses > p");
                            if (noTicketsMessage && noTicketsMessage.textContent.trim() === "{% trans 'No tickets found.' %}") {
                                noTicketsMessage.remove();
                            }

                            const ticket = data.ticket;
                            const newTicketElement = document.createElement("div");
                            newTicketElement.className = "ticket";

                            // Comment Details
                            const commentDetails = document.createElement("div");
                            commentDetails.className = "comment-details";

                            const h4 = document.createElement("h4");
                            h4.innerHTML = `${ticket.subject} <span class="place-name">${ticket.date_updated}</span>`;

                            const h5 = document.createElement("h5");
                            h5.textContent = ticket.status;

                            const p = document.createElement("p");
                            p.textContent = ticket.message;

                            commentDetails.appendChild(h4);
                            commentDetails.appendChild(h5);
                            commentDetails.appendChild(p);

                            const repliesDiv = document.createElement("div");
                            repliesDiv.className = "replies";

                            const noReplies = document.createElement("p");
                            noReplies.className = "no-replies";
                            noReplies.textContent = "{% trans 'No replies yet.' %}";

                            repliesDiv.appendChild(noReplies);

                            newTicketElement.appendChild(commentDetails);
                            newTicketElement.appendChild(repliesDiv);

                            document.getElementById("responses").prepend(newTicketElement);

                            showMessage(data.message, 'success')
                        }
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                        alert("{% trans 'An error occurred while submitting the form.' %}");
                    });
            });
        }

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showMessage(text, type) {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = text;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), type === 'error' ? 5000 : 3000);
        }

    });

    document.addEventListener('DOMContentLoaded', function () {
        const closeButtons = document.querySelectorAll('.alert__close');
        closeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const alert = this.closest('.alert');
                alert.classList.add('hide');
                setTimeout(() => alert.remove(), 300);
            });
        });

        document.querySelectorAll('.alert').forEach(alert => {
            setTimeout(() => {
                alert.classList.add('hide');
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        });
    });
    
    let isInitialized = false;
    document.addEventListener('DOMContentLoaded', () => {
        if (isInitialized) {
            console.warn('Initialization already performed. Skipping...');
            return;
        }
    
        isInitialized = true;

        const copyButtons = document.querySelectorAll('.copy');

        copyButtons.forEach(button => {
            button.addEventListener('click', async () => {
                const link = button.getAttribute('data-link');

                try {
                    await navigator.clipboard.writeText(link);

                button.classList.add('copied');
                setTimeout(() => {
                    button.classList.remove('copied');
                }, 1000);
                } catch (error) {
                    console.error('Failed to copy link:', error);
                    alert('Failed to copy the link. Please try again.');
                }
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
